<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoice Manager</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #F2F4F8;
  --surface: #FFFFFF;
  --surface2: #F8F9FC;
  --border: #E4E8F0;
  --border2: #D0D7E6;
  --accent: #2563EB;
  --accent2: #1D4ED8;
  --accent-light: #EEF2FF;
  --accent-soft: #DBEAFE;
  --text: #111827;
  --text2: #374151;
  --text3: #6B7280;
  --text4: #9CA3AF;
  --success: #059669;
  --success-bg: #ECFDF5;
  --danger: #DC2626;
  --danger-bg: #FEF2F2;
  --warning: #D97706;
  --warning-bg: #FFFBEB;
  --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
  --shadow-md: 0 4px 12px rgba(0,0,0,.08), 0 2px 4px rgba(0,0,0,.04);
  --shadow-lg: 0 10px 30px rgba(0,0,0,.10), 0 4px 8px rgba(0,0,0,.06);
  --radius: 10px;
  --radius-sm: 6px;
  --radius-lg: 16px;
}

* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  display: flex;
}

/* ── SIDEBAR ── */
.sidebar {
  width: 220px;
  min-width: 220px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 100vh;
  position: relative;
  z-index: 10;
}

.sidebar-logo {
  padding: 22px 20px 18px;
  border-bottom: 1px solid var(--border);
}
.sidebar-logo .brand {
  font-family: 'DM Serif Display', serif;
  font-size: 17px;
  color: var(--accent);
  letter-spacing: -.3px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sidebar-logo .brand svg { width:22px; height:22px; }
.sidebar-logo .sub { font-size: 11px; color: var(--text3); margin-top: 2px; letter-spacing:.3px; }

.sidebar-nav { padding: 12px 10px; flex: 1; }

.nav-section-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--text4);
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 8px 10px 4px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--text2);
  font-size: 13.5px;
  font-weight: 500;
  transition: all .15s ease;
  margin-bottom: 2px;
  user-select: none;
}
.nav-item svg { width:17px; height:17px; flex-shrink:0; opacity:.7; }
.nav-item:hover { background: var(--bg); color: var(--text); }
.nav-item:hover svg { opacity:.9; }
.nav-item.active { background: var(--accent-light); color: var(--accent); font-weight: 600; }
.nav-item.active svg { opacity:1; }

.sidebar-footer {
  padding: 14px 16px;
  border-top: 1px solid var(--border);
  font-size: 11px;
  color: var(--text4);
  text-align: center;
}

/* ── MAIN CONTENT ── */
.main { flex:1; height:100vh; overflow-y:auto; display:flex; flex-direction:column; }

.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 14px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky; top:0; z-index:5;
}
.topbar-title { font-size: 16px; font-weight: 700; color: var(--text); }
.topbar-sub { font-size: 12px; color: var(--text3); margin-top: 1px; }
.topbar-actions { display:flex; gap:8px; align-items:center; }

.content { padding: 24px 28px; flex:1; }

/* ── BUTTONS ── */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: var(--radius-sm);
  font-size: 13px; font-weight: 600; cursor: pointer;
  border: none; outline: none;
  transition: all .15s ease; font-family: inherit; white-space: nowrap;
}
.btn svg { width:15px; height:15px; }
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: var(--accent2); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,.3); }
.btn-secondary { background: var(--surface); color: var(--text2); border: 1px solid var(--border2); }
.btn-secondary:hover { background: var(--bg); border-color: var(--border2); }
.btn-danger { background: var(--danger-bg); color: var(--danger); border: 1px solid #FECACA; }
.btn-danger:hover { background: #FEE2E2; }
.btn-success { background: var(--success-bg); color: var(--success); border: 1px solid #A7F3D0; }
.btn-sm { padding: 5px 11px; font-size: 12px; }
.btn-lg { padding: 11px 22px; font-size: 14px; }
.btn:active { transform: none; }

/* ── CARDS ── */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.card-title { font-size: 14px; font-weight: 700; color: var(--text); }
.card-body { padding: 20px; }

/* ── FORM ── */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
.form-full { grid-column: 1 / -1; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 12px; font-weight: 600; color: var(--text2); }
.form-label span { color: var(--text4); font-weight: 400; }
.form-input, .form-select {
  padding: 8px 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit; font-size: 13.5px; color: var(--text);
  background: var(--surface); outline: none;
  transition: border-color .15s, box-shadow .15s;
}
.form-input:focus, .form-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(37,99,235,.08);
}
.form-input::placeholder { color: var(--text4); }
.form-select { cursor: pointer; }
textarea.form-input { resize: vertical; min-height: 70px; }

/* ── STATS ROW ── */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px 20px;
  box-shadow: var(--shadow);
}
.stat-label { font-size: 11.5px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px; }
.stat-value { font-size: 22px; font-weight: 700; color: var(--text); line-height:1; }
.stat-sub { font-size: 11px; color: var(--text3); margin-top: 6px; }
.stat-icon { width:36px; height:36px; border-radius: 8px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; }
.stat-icon svg { width:18px; height:18px; }
.stat-blue .stat-icon { background: var(--accent-soft); color: var(--accent); }
.stat-green .stat-icon { background: var(--success-bg); color: var(--success); }
.stat-orange .stat-icon { background: var(--warning-bg); color: var(--warning); }
.stat-gray .stat-icon { background: #F3F4F6; color: #6B7280; }

/* ── TABLE ── */
.table-wrap { overflow-x:auto; }
table.data-table { width:100%; border-collapse:collapse; }
table.data-table th {
  padding: 10px 14px;
  text-align: left;
  font-size: 11.5px; font-weight: 700;
  color: var(--text3); text-transform: uppercase; letter-spacing: .5px;
  border-bottom: 2px solid var(--border);
  background: var(--surface2);
  white-space: nowrap;
}
table.data-table td {
  padding: 12px 14px;
  font-size: 13.5px;
  border-bottom: 1px solid var(--border);
  color: var(--text2);
  vertical-align: middle;
}
table.data-table tbody tr:hover { background: var(--bg); }
table.data-table tbody tr:last-child td { border-bottom: none; }

.badge {
  display: inline-flex; align-items:center;
  padding: 3px 9px; border-radius: 100px;
  font-size: 11px; font-weight: 600;
}
.badge-blue { background: var(--accent-soft); color: var(--accent); }
.badge-green { background: var(--success-bg); color: var(--success); }
.badge-orange { background: var(--warning-bg); color: var(--warning); }
.badge-gray { background: #F3F4F6; color: #6B7280; }

/* ── PRODUCTS TABLE ── */
.products-table { width:100%; border-collapse:collapse; margin-top:10px; }
.products-table th {
  padding: 8px 10px; text-align:left;
  font-size: 11.5px; font-weight: 700; color: var(--text3);
  border-bottom: 2px solid var(--border); background: var(--surface2);
}
.products-table td { padding: 6px 6px; vertical-align:middle; }
.products-table td input, .products-table td select {
  width: 100%;
  padding: 7px 9px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit; font-size: 13px;
  background: var(--surface); color: var(--text);
  outline: none;
  transition: border-color .15s;
}
.products-table td input:focus, .products-table td select:focus {
  border-color: var(--accent);
}
.products-table .total-cell { font-weight: 600; color: var(--text); text-align:right; padding-right:10px; white-space:nowrap; }
.products-table .btn-remove {
  background: none; border: none; cursor: pointer; padding: 5px;
  color: var(--text4); border-radius: 4px; display:flex;
  transition: color .15s, background .15s;
}
.products-table .btn-remove:hover { color: var(--danger); background: var(--danger-bg); }

/* ── TOTALS SUMMARY ── */
.totals-summary {
  margin-left: auto;
  width: 300px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}
.totals-summary table { width: 100%; border-collapse: collapse; }
.totals-summary td { padding: 9px 16px; font-size: 13.5px; }
.totals-summary tr:not(:last-child) td { border-bottom: 1px solid var(--border); }
.totals-summary td:last-child { text-align:right; font-weight: 600; }
.totals-summary tr.grand-total { background: var(--text); }
.totals-summary tr.grand-total td { color: white; font-size: 15px; font-weight: 700; }

/* ── SECTION DIVIDER ── */
.section-divider {
  font-size: 11.5px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: .8px;
  padding: 4px 0 12px;
  border-bottom: 2px solid var(--border);
  margin-bottom: 16px;
}

/* ── MODAL / PREVIEW ── */
.modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 100;
  align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  max-width: 880px; width: 94%;
  max-height: 90vh;
  overflow: hidden;
  display: flex; flex-direction: column;
}
.modal-header {
  padding: 16px 22px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items:center; justify-content:space-between;
}
.modal-header h3 { font-size:15px; font-weight:700; }
.modal-close {
  width:30px; height:30px; border-radius:6px; border:none;
  background: var(--bg); cursor:pointer; display:flex; align-items:center; justify-content:center;
  color: var(--text3); font-size:18px; transition: background .15s;
}
.modal-close:hover { background: var(--border); }
.modal-body { flex:1; overflow-y:auto; }
.modal-footer { padding:14px 22px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end; }

/* ── TOAST ── */
.toast-container { position:fixed; top:16px; right:16px; z-index:999; display:flex; flex-direction:column; gap:8px; }
.toast {
  padding: 12px 18px; border-radius:8px;
  font-size: 13px; font-weight: 500;
  display: flex; align-items:center; gap:8px;
  box-shadow: var(--shadow-md);
  animation: slideIn .25s ease;
  max-width: 320px;
}
.toast svg { width:16px; height:16px; flex-shrink:0; }
.toast-success { background: #ECFDF5; color: #065F46; border: 1px solid #A7F3D0; }
.toast-error { background: var(--danger-bg); color: #991B1B; border: 1px solid #FECACA; }
.toast-info { background: var(--accent-light); color: #1E40AF; border: 1px solid #BFDBFE; }
@keyframes slideIn { from { opacity:0; transform: translateX(20px); } to { opacity:1; transform:none; } }

/* ── REPORT ── */
.report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom:20px; }
.purpose-table { width:100%; border-collapse:collapse; }
.purpose-table th { padding:8px 12px; text-align:left; font-size:11.5px; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:.5px; border-bottom:2px solid var(--border); }
.purpose-table td { padding:10px 12px; border-bottom:1px solid var(--border); font-size:13.5px; color:var(--text2); }
.purpose-table td:not(:first-child) { text-align:right; font-weight:500; }

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:10px; }

/* ── EMPTY STATE ── */
.empty-state { text-align:center; padding:60px 20px; color:var(--text3); }
.empty-state svg { width:52px; height:52px; opacity:.25; margin-bottom:16px; }
.empty-state h3 { font-size:15px; font-weight:600; color:var(--text2); margin-bottom:6px; }
.empty-state p { font-size:13px; }

/* ── LOGO UPLOAD ── */
.logo-upload-area {
  border: 2px dashed var(--border2);
  border-radius: var(--radius);
  padding: 20px;
  text-align:center;
  cursor:pointer;
  transition: border-color .2s, background .2s;
}
.logo-upload-area:hover { border-color:var(--accent); background:var(--accent-light); }
.logo-preview { max-height:60px; max-width:180px; object-fit:contain; }

/* ── SEARCH ── */
.search-input {
  padding: 7px 12px 7px 34px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit; font-size: 13px;
  background: var(--surface); color: var(--text);
  outline: none; width: 220px;
  transition: border-color .15s, box-shadow .15s;
}
.search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,.08); }
.search-wrap { position:relative; }
.search-wrap svg { position:absolute; left:9px; top:50%; transform:translateY(-50%); width:15px; height:15px; color:var(--text4); }

/* ── DIVIDER ── */
hr.divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

/* ── FILTER BAR ── */
.filter-bar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:18px; }
.filter-bar .form-select { padding:6px 10px; font-size:13px; height:34px; }
.filter-bar .form-input { padding:6px 10px; font-size:13px; height:34px; }
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="4" y="2" width="16" height="20" rx="2"/>
        <path d="M8 7h8M8 11h8M8 15h5"/>
      </svg>
      InvoiceManager
    </div>
    <div class="sub">Netherlands · Euro (€)</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Main</div>
    <div class="nav-item active" onclick="showPage('new-invoice')" data-page="new-invoice">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
      New Invoice
    </div>
    <div class="nav-item" onclick="showPage('invoice-list')" data-page="invoice-list">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      Invoice List
    </div>
    <div class="nav-section-label">Analytics</div>
    <div class="nav-item" onclick="showPage('report')" data-page="report">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      Report
    </div>
    <div class="nav-section-label">System</div>
    <div class="nav-item" onclick="showPage('settings')" data-page="settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 010 14.14M4.93 4.93a10 10 0 000 14.14"/></svg>
      Settings
    </div>
  </nav>
  <div class="sidebar-footer">v1.0 · Offline Ready</div>
</aside>

<!-- MAIN -->
<div class="main">

  <!-- ══ NEW INVOICE PAGE ══ -->
  <div id="page-new-invoice">
    <div class="topbar">
      <div>
        <div class="topbar-title">New Invoice</div>
        <div class="topbar-sub">Nieuwe factuur aanmaken</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-secondary" onclick="resetInvoiceForm()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 019-9 9.75 9.75 0 016.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
          Reset
        </button>
        <button class="btn btn-primary" onclick="previewInvoice()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Preview
        </button>
        <button class="btn btn-primary btn-lg" onclick="saveInvoice()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Opslaan
        </button>
      </div>
    </div>
    <div class="content">
      <form id="invoice-form" onsubmit="return false;">

        <!-- Invoice Info -->
        <div class="card" style="margin-bottom:18px;">
          <div class="card-header"><span class="card-title">Invoice Information</span></div>
          <div class="card-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Factuurnummer *</label>
                <input type="text" class="form-input" id="factuurnummer" placeholder="Auto-generated" readonly style="background:var(--surface2);cursor:default;">
              </div>
              <div class="form-group">
                <label class="form-label">Doel (Purpose) *</label>
                <select class="form-select" id="purpose" onchange="updateFactuurNr()">
                  <option value="">— Select purpose —</option>
                  <option value="BOL">BOL</option>
                  <option value="Best4Juniors">Best4Juniors</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Bestelnummer <span>(optional)</span></label>
                <input type="text" class="form-input" id="bestelnummer" placeholder="B.v. C00008461F">
              </div>
              <div class="form-group">
                <label class="form-label">Factuurdatum *</label>
                <input type="datetime-local" class="form-input" id="invoice-date">
              </div>
              <div class="form-group">
                <label class="form-label">Vervaldatum</label>
                <input type="date" class="form-input" id="due-date">
              </div>
            </div>
          </div>
        </div>

        <!-- Customer Info -->
        <div class="card" style="margin-bottom:18px;">
          <div class="card-header"><span class="card-title">Klantgegevens (Customer Details)</span></div>
          <div class="card-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Naam contactpersoon</label>
                <input type="text" class="form-input" id="customer-name" placeholder="B.v. Wendy de Wilde">
              </div>
              <div class="form-group">
                <label class="form-label">Bedrijfsnaam</label>
                <input type="text" class="form-input" id="customer-company" placeholder="B.v. Stichting Klaver6">
              </div>
              <div class="form-group">
                <label class="form-label">Afdeling / Department <span>(optional)</span></label>
                <input type="text" class="form-input" id="customer-dept" placeholder="B.v. Finance">
              </div>
              <div class="form-group">
                <label class="form-label">Adres</label>
                <input type="text" class="form-input" id="customer-address" placeholder="Straatnaam + huisnummer">
              </div>
              <div class="form-group">
                <label class="form-label">Postcode</label>
                <input type="text" class="form-input" id="customer-postal" placeholder="B.v. 4613 DP">
              </div>
              <div class="form-group">
                <label class="form-label">Stad</label>
                <input type="text" class="form-input" id="customer-city" placeholder="B.v. Bergen op Zoom">
              </div>
              <div class="form-group">
                <label class="form-label">Land</label>
                <input type="text" class="form-input" id="customer-country" value="Netherlands">
              </div>
              <div class="form-group">
                <label class="form-label">Telefoon</label>
                <input type="text" class="form-input" id="customer-phone" placeholder="+31 6 ...">
              </div>
              <div class="form-group">
                <label class="form-label">E-mail</label>
                <input type="email" class="form-input" id="customer-email" placeholder="klant@email.com">
              </div>
              <div class="form-group">
                <label class="form-label">KVK-nummer</label>
                <input type="text" class="form-input" id="customer-kvk" placeholder="B.v. 91427541">
              </div>
            </div>
          </div>
        </div>

        <!-- Products -->
        <div class="card" style="margin-bottom:18px;">
          <div class="card-header">
            <span class="card-title">Producten / Diensten</span>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addProductRow()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              Regel toevoegen
            </button>
          </div>
          <div class="card-body" style="padding-bottom:10px;">
            <div class="table-wrap">
              <table class="products-table">
                <thead>
                  <tr>
                    <th style="width:48%;">Productnaam / Omschrijving</th>
                    <th style="width:10%;">Aantal</th>
                    <th style="width:15%;">Prijs (€)</th>
                    <th style="width:15%;">Totaal (€)</th>
                    <th style="width:6%;"></th>
                  </tr>
                </thead>
                <tbody id="products-body">
                </tbody>
              </table>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:18px;">
              <div class="totals-summary">
                <table>
                  <tr><td style="color:var(--text3);">Subtotaal (excl. BTW)</td><td id="display-subtotaal">€ 0,00</td></tr>
                  <tr><td style="color:var(--text3);">BTW (<span id="display-btw-pct">21</span>%)</td><td id="display-btw">€ 0,00</td></tr>
                  <tr class="grand-total"><td>TOTAAL (incl. BTW)</td><td id="display-totaal">€ 0,00</td></tr>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="card">
          <div class="card-header"><span class="card-title">Notities <span style="font-weight:400;font-size:12px;color:var(--text3);">(optional)</span></span></div>
          <div class="card-body">
            <textarea class="form-input" id="invoice-notes" rows="3" placeholder="Extra informatie of opmerkingen..."></textarea>
          </div>
        </div>

      </form>
    </div>
  </div>

  <!-- ══ INVOICE LIST PAGE ══ -->
  <div id="page-invoice-list" style="display:none;">
    <div class="topbar">
      <div>
        <div class="topbar-title">Invoice List</div>
        <div class="topbar-sub">Alle opgeslagen facturen</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-secondary btn-sm" onclick="exportCSV()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export CSV
        </button>
        <button class="btn btn-primary" onclick="showPage('new-invoice')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          Nieuwe Factuur
        </button>
      </div>
    </div>
    <div class="content">
      <div class="filter-bar">
        <div class="search-wrap">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input type="text" class="search-input" id="list-search" placeholder="Zoeken..." oninput="filterInvoiceList()">
        </div>
        <select class="form-select" id="list-purpose-filter" onchange="filterInvoiceList()" style="height:34px;padding:6px 10px;font-size:13px;">
          <option value="all">All Purposes</option>
          <option value="BOL">BOL</option>
          <option value="Best4Juniors">Best4Juniors</option>
          <option value="Other">Other</option>
        </select>
        <input type="date" class="form-input" id="list-date-from" oninput="filterInvoiceList()" style="height:34px;padding:6px 10px;font-size:13px;width:150px;" placeholder="Van">
        <input type="date" class="form-input" id="list-date-to" oninput="filterInvoiceList()" style="height:34px;padding:6px 10px;font-size:13px;width:150px;" placeholder="Tot">
      </div>
      <div class="card">
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>Factuurnummer</th>
                <th>Klant</th>
                <th>Datum</th>
                <th>Doel</th>
                <th>Totaal</th>
                <th>Acties</th>
              </tr>
            </thead>
            <tbody id="invoice-list-body">
              <tr><td colspan="6"><div class="empty-state"><p>Laden...</p></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ══ REPORT PAGE ══ -->
  <div id="page-report" style="display:none;">
    <div class="topbar">
      <div>
        <div class="topbar-title">Report</div>
        <div class="topbar-sub">Omzetoverzicht en statistieken</div>
      </div>
    </div>
    <div class="content">
      <div class="filter-bar" style="margin-bottom:20px;">
        <select class="form-select" id="report-period" onchange="applyReportFilter()" style="height:34px;padding:6px 10px;font-size:13px;">
          <option value="all">All Time</option>
          <option value="month">This Month</option>
          <option value="custom">Custom Range</option>
        </select>
        <select class="form-select" id="report-purpose" onchange="applyReportFilter()" style="height:34px;padding:6px 10px;font-size:13px;">
          <option value="all">All Purposes</option>
          <option value="BOL">BOL</option>
          <option value="Best4Juniors">Best4Juniors</option>
          <option value="Other">Other</option>
        </select>
        <div id="custom-date-range" style="display:none;gap:8px;align-items:center;display:none;">
          <input type="date" class="form-input" id="report-from" oninput="applyReportFilter()" style="height:34px;padding:6px 10px;font-size:13px;width:145px;">
          <span style="color:var(--text3);font-size:13px;">tot</span>
          <input type="date" class="form-input" id="report-to" oninput="applyReportFilter()" style="height:34px;padding:6px 10px;font-size:13px;width:145px;">
        </div>
      </div>

      <div class="stats-row" id="report-stats">
        <div class="stat-card stat-blue">
          <div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg></div>
          <div class="stat-label">Total Invoices</div>
          <div class="stat-value" id="r-count">—</div>
        </div>
        <div class="stat-card stat-green">
          <div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></div>
          <div class="stat-label">Total Revenue</div>
          <div class="stat-value" id="r-revenue">—</div>
        </div>
        <div class="stat-card stat-orange">
          <div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 14l6-6"/><circle cx="9.5" cy="8.5" r="1.5"/><circle cx="14.5" cy="15.5" r="1.5"/><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div>
          <div class="stat-label">BTW Collected</div>
          <div class="stat-value" id="r-btw">—</div>
        </div>
        <div class="stat-card stat-gray">
          <div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div>
          <div class="stat-label">Subtotaal (excl. BTW)</div>
          <div class="stat-value" id="r-subtotaal">—</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Revenue by Purpose</span></div>
        <div class="card-body">
          <table class="purpose-table">
            <thead><tr><th>Doel</th><th style="text-align:right">Facturen</th><th style="text-align:right">Subtotaal</th><th style="text-align:right">BTW</th><th style="text-align:right">Totaal</th></tr></thead>
            <tbody id="report-purpose-body"><tr><td colspan="5" style="text-align:center;color:var(--text3);padding:20px;">Rapport laden...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ══ SETTINGS PAGE ══ -->
  <div id="page-settings" style="display:none;">
    <div class="topbar">
      <div>
        <div class="topbar-title">Settings</div>
        <div class="topbar-sub">Bedrijfsinformatie en configuratie</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-primary btn-lg" onclick="saveSettings()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Instellingen Opslaan
        </button>
      </div>
    </div>
    <div class="content">
      <div class="card" style="margin-bottom:18px;">
        <div class="card-header"><span class="card-title">Company Logo</span></div>
        <div class="card-body">
          <div style="display:flex;align-items:center;gap:20px;">
            <div class="logo-upload-area" onclick="document.getElementById('logo-file').click()" style="min-width:160px;" id="logo-drop-area">
              <img id="logo-preview" class="logo-preview" style="display:none;">
              <div id="logo-placeholder" style="color:var(--text3);font-size:13px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:28px;height:28px;margin:0 auto 8px;display:block;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                Klik om logo te uploaden
              </div>
            </div>
            <div style="font-size:12px;color:var(--text3);">
              Aanbevolen: PNG of SVG<br>Max. hoogte: 60px op factuur
            </div>
          </div>
          <input type="file" id="logo-file" accept="image/*" style="display:none;" onchange="uploadLogo(this)">
        </div>
      </div>

      <div class="card" style="margin-bottom:18px;">
        <div class="card-header"><span class="card-title">Bedrijfsgegevens</span></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group form-full">
              <label class="form-label">Bedrijfsnaam *</label>
              <input type="text" class="form-input" id="s-company" placeholder="B.v. Best4Juniors BV">
            </div>
            <div class="form-group form-full">
              <label class="form-label">Adres</label>
              <input type="text" class="form-input" id="s-address" placeholder="B.v. Boxcomplex Weert, 21B128 Hoolstraat 21">
            </div>
            <div class="form-group">
              <label class="form-label">Postcode</label>
              <input type="text" class="form-input" id="s-postal" placeholder="B.v. 6006 SL">
            </div>
            <div class="form-group">
              <label class="form-label">Stad</label>
              <input type="text" class="form-input" id="s-city" placeholder="B.v. Weert">
            </div>
            <div class="form-group">
              <label class="form-label">Land</label>
              <input type="text" class="form-input" id="s-country" value="Netherlands">
            </div>
            <div class="form-group">
              <label class="form-label">Telefoon</label>
              <input type="text" class="form-input" id="s-phone" placeholder="+31 6 18928041">
            </div>
            <div class="form-group">
              <label class="form-label">E-mail</label>
              <input type="email" class="form-input" id="s-email" placeholder="support@best4juniors.nl">
            </div>
            <div class="form-group">
              <label class="form-label">Website</label>
              <input type="text" class="form-input" id="s-website" placeholder="https://best4juniors.nl">
            </div>
            <div class="form-group">
              <label class="form-label">KVK-nummer</label>
              <input type="text" class="form-input" id="s-kvk" placeholder="B.v. 91427541">
            </div>
            <div class="form-group">
              <label class="form-label">BTW-nummer</label>
              <input type="text" class="form-input" id="s-btw-number" placeholder="B.v. NL865654360B01">
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Invoice Defaults</span></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Standaard BTW (%)</label>
              <input type="number" class="form-input" id="s-btw-pct" value="21" min="0" max="100" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Betalingstermijn (dagen)</label>
              <input type="number" class="form-input" id="s-payment-days" value="14" min="0">
            </div>
            <div class="form-group form-full">
              <label class="form-label">Support e-mail (footer factuur)</label>
              <input type="email" class="form-input" id="s-support-email" placeholder="support@bedrijf.nl">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══ PREVIEW MODAL ══ -->
<div class="modal-overlay" id="preview-modal">
  <div class="modal" style="max-width:900px;">
    <div class="modal-header">
      <h3>Invoice Preview</h3>
      <button class="modal-close" onclick="closeModal('preview-modal')">×</button>
    </div>
    <div class="modal-body" style="padding:0;">
      <iframe id="preview-iframe" style="width:100%;height:560px;border:none;background:white;"></iframe>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('preview-modal')">Sluiten</button>
      <button class="btn btn-primary" onclick="saveAndGenerate()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:15px;height:15px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Opslaan & PDF
      </button>
    </div>
  </div>
</div>

<!-- ══ INVOICE VIEW MODAL ══ -->
<div class="modal-overlay" id="view-modal">
  <div class="modal" style="max-width:900px;">
    <div class="modal-header">
      <h3 id="view-modal-title">Factuur bekijken</h3>
      <button class="modal-close" onclick="closeModal('view-modal')">×</button>
    </div>
    <div class="modal-body" style="padding:0;">
      <iframe id="view-iframe" style="width:100%;height:560px;border:none;background:white;"></iframe>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('view-modal')">Sluiten</button>
      <button class="btn btn-primary" onclick="generatePDF(currentViewId)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:15px;height:15px;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Open als PDF
      </button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toast-container"></div>

<script>
let currentInvoiceId = null;
let currentViewId = null;
let productRowCount = 0;
let allInvoices = [];

// ── INIT ──
async function init() {
  setupDateFields();
  await loadSettings();
  await loadInvoiceNumber();
  addProductRow();
}

function setupDateFields() {
  const now = new Date();
  const local = now.toISOString().slice(0,16);
  document.getElementById('invoice-date').value = local;
  const due = new Date(now);
  const days = parseInt(window._settings?.payment_days || 14);
  due.setDate(due.getDate() + days);
  document.getElementById('due-date').value = due.toISOString().slice(0,10);
}

async function loadSettings() {
  try {
    const s = await window.pywebview.api.get_settings();
    window._settings = s;
    if (s.company_name) document.getElementById('s-company').value = s.company_name || '';
    if (s.address) document.getElementById('s-address').value = s.address || '';
    if (s.postal) document.getElementById('s-postal').value = s.postal || '';
    if (s.city) document.getElementById('s-city').value = s.city || '';
    if (s.country) document.getElementById('s-country').value = s.country || 'Netherlands';
    if (s.phone) document.getElementById('s-phone').value = s.phone || '';
    if (s.email) document.getElementById('s-email').value = s.email || '';
    if (s.website) document.getElementById('s-website').value = s.website || '';
    if (s.kvk) document.getElementById('s-kvk').value = s.kvk || '';
    if (s.btw_number) document.getElementById('s-btw-number').value = s.btw_number || '';
    if (s.btw_pct) document.getElementById('s-btw-pct').value = s.btw_pct || '21';
    if (s.payment_days) document.getElementById('s-payment-days').value = s.payment_days || '14';
    if (s.support_email) document.getElementById('s-support-email').value = s.support_email || '';
    document.getElementById('display-btw-pct').textContent = s.btw_pct || '21';
    // Load logo
    const logo = await window.pywebview.api.get_logo_base64();
    if (logo.data) {
      document.getElementById('logo-preview').src = logo.data;
      document.getElementById('logo-preview').style.display = 'block';
      document.getElementById('logo-placeholder').style.display = 'none';
    }
  } catch(e) { console.log('Settings load error', e); }
}

async function loadInvoiceNumber() {
  try {
    const purpose = document.getElementById('purpose').value;
    const res = await window.pywebview.api.new_invoice_number(purpose);
    document.getElementById('factuurnummer').value = res.factuurnummer;
  } catch(e) {}
}

// ── NAVIGATION ──
function showPage(page) {
  document.querySelectorAll('[id^="page-"]').forEach(el => el.style.display = 'none');
  document.getElementById('page-' + page).style.display = 'flex';
  document.getElementById('page-' + page).style.flexDirection = 'column';
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
  if (page === 'invoice-list') loadInvoiceList();
  if (page === 'report') loadReport();
  if (page === 'settings') loadSettings();
}

// ── PRODUCT ROWS ──
function addProductRow() {
  const id = ++productRowCount;
  const tbody = document.getElementById('products-body');
  const tr = document.createElement('tr');
  tr.id = `row-${id}`;
  tr.innerHTML = `
    <td><input type="text" placeholder="Productnaam / Omschrijving" class="p-name"></td>
    <td><input type="number" placeholder="1" min="0" class="p-aantal" value="1" oninput="calcRow(${id})"></td>
    <td><input type="number" placeholder="0.00" step="0.01" min="0" class="p-prijs" oninput="calcRow(${id})"></td>
    <td class="total-cell" id="row-total-${id}">€ 0,00</td>
    <td><button class="btn-remove" onclick="removeRow(${id})" title="Verwijderen">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:15px;height:15px;"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button></td>`;
  tbody.appendChild(tr);
}

function removeRow(id) {
  const row = document.getElementById(`row-${id}`);
  if (row) row.remove();
  calcTotals();
}

function calcRow(id) {
  const row = document.getElementById(`row-${id}`);
  if (!row) return;
  const prijs = parseFloat(row.querySelector('.p-prijs').value) || 0;
  const aantal = parseFloat(row.querySelector('.p-aantal').value) || 0;
  const total = prijs * aantal;
  document.getElementById(`row-total-${id}`).textContent = '€ ' + total.toFixed(2).replace('.', ',');
  calcTotals();
}

function calcTotals() {
  // Price entered INCL. BTW — total first, then extract subtotaal
  let totaal = 0;
  document.querySelectorAll('#products-body tr').forEach(tr => {
    const prijs = parseFloat(tr.querySelector('.p-prijs')?.value) || 0;
    const aantal = parseFloat(tr.querySelector('.p-aantal')?.value) || 0;
    totaal += prijs * aantal;
  });
  const btw_pct = parseFloat(window._settings?.btw_pct || 21);
  const subtotaal = totaal / (1 + btw_pct / 100);
  const btw = totaal - subtotaal;
  document.getElementById('display-subtotaal').textContent = '€ ' + subtotaal.toFixed(2).replace('.',',');
  document.getElementById('display-btw').textContent = '€ ' + btw.toFixed(2).replace('.',',');
  document.getElementById('display-totaal').textContent = '€ ' + totaal.toFixed(2).replace('.',',');
  document.getElementById('display-btw-pct').textContent = btw_pct;
}

async function updateFactuurNr() {
  await loadInvoiceNumber();
}

function getInvoiceData() {
  const items = [];
  document.querySelectorAll('#products-body tr').forEach(tr => {
    const name = tr.querySelector('.p-name')?.value?.trim();
    const prijs = parseFloat(tr.querySelector('.p-prijs')?.value) || 0;
    const aantal = parseFloat(tr.querySelector('.p-aantal')?.value) || 0;
    if (name || prijs) items.push({ productnaam: name, prijs, aantal });
  });
  const btw_pct = parseFloat(window._settings?.btw_pct || 21);
  const rawDate = document.getElementById('invoice-date').value;
  const displayDate = rawDate ? rawDate.replace('T', ' ') : '';
  return {
    id: currentInvoiceId,
    factuurnummer: document.getElementById('factuurnummer').value,
    purpose: document.getElementById('purpose').value,
    bestelnummer: document.getElementById('bestelnummer').value,
    date: displayDate,
    due_date: document.getElementById('due-date').value,
    customer_name: document.getElementById('customer-name').value,
    customer_company: document.getElementById('customer-company').value,
    customer_dept: document.getElementById('customer-dept').value,
    customer_address: document.getElementById('customer-address').value,
    customer_postal: document.getElementById('customer-postal').value,
    customer_city: document.getElementById('customer-city').value,
    customer_country: document.getElementById('customer-country').value,
    customer_phone: document.getElementById('customer-phone').value,
    customer_email: document.getElementById('customer-email').value,
    customer_kvk: document.getElementById('customer-kvk').value,
    items, btw_pct,
    notes: document.getElementById('invoice-notes').value
  };
}

async function previewInvoice() {
  const data = getInvoiceData();
  if (!data.factuurnummer) { toast('Factuurnummer ontbreekt', 'error'); return; }
  // Build preview HTML inline
  const settings = window._settings || {};
  const logo = await window.pywebview.api.get_logo_base64();
  // Price entered INCL BTW — reverse extract
  const btw_pct_num = parseFloat(data.btw_pct || 21);
  let totaal = 0;
  data.items.forEach(i => { totaal += parseFloat(i.prijs||0) * parseFloat(i.aantal||0); });
  const subtotaal = totaal / (1 + btw_pct_num / 100);
  const btw = totaal - subtotaal;
  // Generate items HTML: Omschrijving | Aantal | Prijs | Totaal
  let itemsRows = data.items.map(i => {
    const total = (parseFloat(i.prijs||0) * parseFloat(i.aantal||0)).toFixed(2);
    return `<tr><td>${i.productnaam||''}</td><td class="tdr">${i.aantal}</td><td class="tdr">€ ${parseFloat(i.prijs).toFixed(2).replace('.',',')}</td><td class="tdr">€ ${total.replace('.',',')}</td></tr>`;
  }).join('');
  const logoHtml = logo.data ? `<img src="${logo.data}" style="max-height:55pt;max-width:140pt;object-fit:contain;" alt="Logo">` : `<div style="font-size:18pt;font-weight:bold;color:#333;">${settings.company_name||''}</div>`;
  const previewHtml = buildPreviewHtml(data, settings, logoHtml, itemsRows, btw, totaal, subtotaal);
  const iframe = document.getElementById('preview-iframe');
  iframe.srcdoc = previewHtml;
  document.getElementById('preview-modal').classList.add('open');
}

function buildPreviewHtml(data, s, logoHtml, itemsRows, btw, totaal, subtotaal) {
  const coInfo = [
    s.address,
    ((s.postal||'')+' '+(s.city||'')).trim(),
    s.phone    ? 'Tel: '+s.phone       : '',
    s.email    ? 'E-mail: '+s.email    : '',
    s.website  ? 'Website: '+s.website : '',
    s.kvk      ? 'KVK: '+s.kvk        : '',
    s.btw_number ? 'BTW: '+s.btw_number : ''
  ].filter(Boolean).join('<br>');

  // Customer lines right-aligned — company first, then name, address, city
  const custLines = [];
  if (data.customer_company) custLines.push(data.customer_company + (data.customer_dept ? ' t.a.v. '+data.customer_dept : ''));
  if (data.customer_name)    custLines.push(data.customer_name);
  if (data.customer_address) custLines.push(data.customer_address);
  const pc = ((data.customer_postal||'')+' '+(data.customer_city||'')).trim();
  if (pc) custLines.push(pc + (data.customer_country ? ', '+data.customer_country : ''));
  const custHtml = custLines.join('<br>');

  const bestelnrRow = data.bestelnummer
    ? `<tr><td class="ml">Bestelnummer:</td><td class="mv">${data.bestelnummer}</td></tr>` : '';
  const supportEmail = s.support_email || s.email || '';
  const fmt = v => `€ ${parseFloat(v).toFixed(2).replace('.',',')}`;

  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{
  font-family:Arial,Helvetica,sans-serif;
  font-size:9pt;color:#333;
  background:#d0d0d0;
}
/* A4 card */
.page{
  width:210mm;min-height:297mm;
  margin:8mm auto;
  background:white;
  padding:16mm 18mm 22mm 18mm;
  position:relative;
  box-shadow:0 2px 16px rgba(0,0,0,.18);
}
/* ── header: logo left | FACTUUR right ── */
.hdr{display:table;width:100%;margin-bottom:6pt;}
.hdr-l{display:table-cell;vertical-align:top;width:50%;}
.hdr-r{display:table-cell;vertical-align:top;width:50%;text-align:right;}
.title{font-size:26pt;font-weight:700;color:#111;letter-spacing:1px;line-height:1;}
/* ── info row: co-info left | meta+klantgegevens right ── */
.info{display:table;width:100%;margin-top:4pt;}
.info-l{display:table-cell;vertical-align:top;width:50%;}
.info-r{display:table-cell;vertical-align:top;width:50%;text-align:right;}
.co-info{font-size:8.5pt;line-height:1.65;color:#333;}
/* meta table */
.meta{border-collapse:collapse;margin-left:auto;}
.meta td{padding:1.5pt 0;font-size:8.5pt;line-height:1.55;}
.ml{color:#555;padding-right:14pt;white-space:nowrap;text-align:left;}
.mv{color:#111;text-align:right;white-space:nowrap;}
/* Klantgegevens */
.klant-lbl{font-size:8.5pt;font-weight:bold;color:#333;text-align:right;margin-top:8pt;}
.klant-body{font-size:8.5pt;line-height:1.65;color:#333;text-align:right;margin-top:2pt;}
/* divider */
.divider{height:1px;background:#bbb;margin:10pt 0 0 0;}
/* items table */
table.items{width:100%;border-collapse:collapse;margin-top:0;}
table.items th{
  padding:7pt 8pt;font-size:9pt;font-weight:bold;color:#333;
  border-top:1px solid #bbb;border-bottom:1px solid #bbb;
  background:white;text-align:left;
}
table.items th.thr{text-align:right;}
table.items td{padding:7pt 8pt;font-size:9pt;color:#333;border-bottom:1px solid #eee;}
table.items td.tdr{text-align:right;}
table.items tbody tr:last-child td{border-bottom:none;}
/* totals */
.totals{margin-top:8pt;}
.tot-tbl{margin-left:auto;border-collapse:collapse;width:220pt;}
.tot-tbl td{padding:4pt 8pt;font-size:9pt;}
.tot-tbl td.tl{color:#333;text-align:left;}
.tot-tbl td.tv{color:#333;text-align:right;white-space:nowrap;}
.tot-grand td{background:#111;color:white!important;font-weight:bold;padding:5pt 8pt;}
/* notes */
.notes{margin-top:10pt;font-size:8.5pt;color:#777;}
/* footer — pinned to bottom of .page */
.footer{
  position:absolute;
  bottom:12mm;left:18mm;right:18mm;
  text-align:center;
  font-size:8pt;color:#666;
  border-top:1px solid #ccc;
  padding-top:5pt;
}
</style></head><body>
<div class="page">

  <div class="hdr">
    <div class="hdr-l">${logoHtml}</div>
    <div class="hdr-r"><div class="title">FACTUUR</div></div>
  </div>

  <div class="info">
    <div class="info-l"><div class="co-info">${coInfo}</div></div>
    <div class="info-r">
      <table class="meta">
        <tr><td class="ml">Factuurnummer:</td><td class="mv">${data.factuurnummer}</td></tr>
        <tr><td class="ml">Datum:</td><td class="mv">${data.date}</td></tr>
        <tr><td class="ml">Vervaldatum:</td><td class="mv">${data.due_date||''}</td></tr>
        ${bestelnrRow}
      </table>
      <div class="klant-lbl">Klantgegevens:</div>
      <div class="klant-body">${custHtml}</div>
    </div>
  </div>

  <div class="divider"></div>

  <table class="items">
    <thead>
      <tr>
        <th style="width:56%;">Omschrijving</th>
        <th class="thr" style="width:10%;">Aantal</th>
        <th class="thr" style="width:17%;">Prijs (€)</th>
        <th class="thr" style="width:17%;">Totaal (€)</th>
      </tr>
    </thead>
    <tbody>${itemsRows}</tbody>
  </table>

  <div class="totals">
    <table class="tot-tbl">
      <tr><td class="tl">Subtotaal (excl. BTW):</td><td class="tv">€ ${subtotaal.toFixed(2).replace('.',',')}</td></tr>
      <tr><td class="tl">BTW (${data.btw_pct}%):</td><td class="tv">€ ${btw.toFixed(2).replace('.',',')}</td></tr>
      <tr class="tot-grand"><td class="tl">TOTAAL (incl. BTW):</td><td class="tv">€ ${totaal.toFixed(2).replace('.',',')}</td></tr>
    </table>
  </div>

  ${data.notes ? `<div class="notes">${data.notes}</div>` : ''}

  <div class="footer">
    Vragen over deze factuur? Mail ons via ${supportEmail}
  </div>

</div></body></html>`;
}

async function saveInvoice() {
  const data = getInvoiceData();
  if (!data.purpose) { toast('Selecteer een doel (purpose)', 'error'); return; }
  if (data.items.length === 0) { toast('Voeg minstens 1 product toe', 'error'); return; }
  try {
    const res = await window.pywebview.api.save_invoice(data);
    currentInvoiceId = res.id;
    toast('Factuur opgeslagen!', 'success');
    generatePDF(res.id);
  } catch(e) { toast('Fout bij opslaan', 'error'); }
}

async function saveAndGenerate() {
  closeModal('preview-modal');
  await saveInvoice();
}

async function generatePDF(invId) {
  toast('PDF wordt gegenereerd...', 'info');
  try {
    const res = await window.pywebview.api.save_invoice_file(invId);
    if (res && res.success) {
      await window.pywebview.api.open_file(res.path);
      if (res.fallback) toast('Geopend als HTML (PDF mislukt)', 'info');
      else toast('PDF geopend! ✓', 'success');
    } else {
      toast('PDF genereren mislukt', 'error');
    }
  } catch(e) {
    console.error('PDF error:', e);
    toast('PDF genereren mislukt', 'error');
  }
}

function resetInvoiceForm() {
  currentInvoiceId = null;
  document.getElementById('purpose').value = '';
  document.getElementById('bestelnummer').value = '';
  document.getElementById('customer-name').value = '';
  document.getElementById('customer-company').value = '';
  document.getElementById('customer-dept').value = '';
  document.getElementById('customer-address').value = '';
  document.getElementById('customer-postal').value = '';
  document.getElementById('customer-city').value = '';
  document.getElementById('customer-country').value = 'Netherlands';
  document.getElementById('customer-phone').value = '';
  document.getElementById('customer-email').value = '';
  document.getElementById('customer-kvk').value = '';
  document.getElementById('invoice-notes').value = '';
  document.getElementById('products-body').innerHTML = '';
  productRowCount = 0;
  addProductRow();
  setupDateFields();
  loadInvoiceNumber();
  toast('Formulier gereset', 'info');
}

// ── INVOICE LIST ──
async function loadInvoiceList() {
  const filters = {};
  const purpose = document.getElementById('list-purpose-filter').value;
  if (purpose !== 'all') filters.purpose = purpose;
  const df = document.getElementById('list-date-from').value;
  const dt = document.getElementById('list-date-to').value;
  if (df) filters.date_from = df;
  if (dt) filters.date_to = dt;
  try {
    allInvoices = await window.pywebview.api.get_invoices(filters);
    renderInvoiceList(allInvoices);
  } catch(e) { console.error(e); }
}

function filterInvoiceList() { loadInvoiceList(); }

function renderInvoiceList(invoices) {
  const tbody = document.getElementById('invoice-list-body');
  const search = document.getElementById('list-search')?.value?.toLowerCase() || '';
  const filtered = invoices.filter(inv => {
    if (!search) return true;
    return (inv.factuurnummer||'').toLowerCase().includes(search) ||
           (inv.customer_company||'').toLowerCase().includes(search) ||
           (inv.customer_name||'').toLowerCase().includes(search);
  });
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      <h3>Geen facturen gevonden</h3>
      <p>Maak een nieuwe factuur aan om te beginnen.</p>
    </div></td></tr>`;
    return;
  }
  const badgeClass = p => p === 'BOL' ? 'badge-blue' : p === 'Best4Juniors' ? 'badge-green' : 'badge-gray';
  tbody.innerHTML = filtered.map(inv => `
    <tr>
      <td><strong>${inv.factuurnummer}</strong></td>
      <td>${inv.customer_company || inv.customer_name || '—'}</td>
      <td>${inv.date ? inv.date.split(' ')[0] : '—'}</td>
      <td><span class="badge ${badgeClass(inv.purpose)}">${inv.purpose || 'Other'}</span></td>
      <td><strong>€ ${parseFloat(inv.totaal).toFixed(2)}</strong></td>
      <td>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-secondary btn-sm" onclick="viewInvoice('${inv.id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            Bekijken
          </button>
          <button class="btn btn-secondary btn-sm" onclick="generatePDF('${inv.id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            PDF
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${inv.id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>
          </button>
        </div>
      </td>
    </tr>`).join('');
}

async function viewInvoice(invId) {
  currentViewId = invId;
  try {
    const res = await window.pywebview.api.get_invoice_html(invId);
    if (res.success) {
      const iframe = document.getElementById('view-iframe');
      iframe.srcdoc = res.html;
      document.getElementById('view-modal').classList.add('open');
    }
  } catch(e) { toast('Factuur laden mislukt', 'error'); }
}

async function deleteInvoice(invId) {
  if (!confirm('Factuur verwijderen? Dit kan niet ongedaan worden gemaakt.')) return;
  try {
    await window.pywebview.api.delete_invoice(invId);
    toast('Factuur verwijderd', 'success');
    loadInvoiceList();
  } catch(e) { toast('Verwijderen mislukt', 'error'); }
}

async function exportCSV() {
  try {
    const res = await window.pywebview.api.export_csv();
    const blob = new Blob([res.csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `facturen_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    toast('CSV geëxporteerd', 'success');
  } catch(e) { toast('Export mislukt', 'error'); }
}

// ── REPORT ──
async function loadReport() {
  await applyReportFilter();
}

async function applyReportFilter() {
  const period = document.getElementById('report-period').value;
  const purpose = document.getElementById('report-purpose').value;
  const customRange = document.getElementById('custom-date-range');
  if (period === 'custom') customRange.style.display = 'flex';
  else customRange.style.display = 'none';
  const filters = {};
  if (purpose !== 'all') filters.purpose = purpose;
  if (period === 'month') {
    const now = new Date();
    filters.date_from = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
    filters.date_to = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().slice(0,10);
  } else if (period === 'custom') {
    const df = document.getElementById('report-from').value;
    const dt = document.getElementById('report-to').value;
    if (df) filters.date_from = df;
    if (dt) filters.date_to = dt;
  }
  try {
    const r = await window.pywebview.api.get_report(filters);
    document.getElementById('r-count').textContent = r.count;
    document.getElementById('r-revenue').textContent = '€ ' + r.total_revenue.toFixed(2);
    document.getElementById('r-btw').textContent = '€ ' + r.total_btw.toFixed(2);
    document.getElementById('r-subtotaal').textContent = '€ ' + r.subtotaal.toFixed(2);
    const tbody = document.getElementById('report-purpose-body');
    const purposes = Object.entries(r.by_purpose);
    if (!purposes.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:20px;">Geen gegevens beschikbaar</td></tr>';
    } else {
      tbody.innerHTML = purposes.map(([p, d]) => `
        <tr>
          <td><span class="badge ${p==='BOL'?'badge-blue':p==='Best4Juniors'?'badge-green':'badge-gray'}">${p}</span></td>
          <td style="text-align:right">${d.count}</td>
          <td style="text-align:right">€ ${(d.revenue - d.btw).toFixed(2)}</td>
          <td style="text-align:right">€ ${d.btw.toFixed(2)}</td>
          <td style="text-align:right"><strong>€ ${d.revenue.toFixed(2)}</strong></td>
        </tr>`).join('');
    }
  } catch(e) { console.error(e); }
}

// ── SETTINGS ──
async function saveSettings() {
  const data = {
    company_name: document.getElementById('s-company').value,
    address: document.getElementById('s-address').value,
    postal: document.getElementById('s-postal').value,
    city: document.getElementById('s-city').value,
    country: document.getElementById('s-country').value,
    phone: document.getElementById('s-phone').value,
    email: document.getElementById('s-email').value,
    website: document.getElementById('s-website').value,
    kvk: document.getElementById('s-kvk').value,
    btw_number: document.getElementById('s-btw-number').value,
    btw_pct: document.getElementById('s-btw-pct').value,
    payment_days: document.getElementById('s-payment-days').value,
    support_email: document.getElementById('s-support-email').value,
  };
  try {
    await window.pywebview.api.save_settings(data);
    window._settings = data;
    document.getElementById('display-btw-pct').textContent = data.btw_pct;
    toast('Instellingen opgeslagen!', 'success');
  } catch(e) { toast('Opslaan mislukt', 'error'); }
}

async function uploadLogo(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const res = await window.pywebview.api.upload_logo(e.target.result, file.name);
      if (res.success) {
        document.getElementById('logo-preview').src = e.target.result;
        document.getElementById('logo-preview').style.display = 'block';
        document.getElementById('logo-placeholder').style.display = 'none';
        toast('Logo geüpload!', 'success');
      }
    } catch(err) { toast('Logo upload mislukt', 'error'); }
  };
  reader.readAsDataURL(file);
}

// ── MODAL ──
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

// ── TOAST ──
function toast(msg, type='info') {
  const icons = {
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
  };
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.innerHTML = icons[type] + msg;
  document.getElementById('toast-container').appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// ── START ──
// Wait for pywebview API to be ready
function waitForAPI() {
  if (window.pywebview && window.pywebview.api) {
    init();
  } else {
    setTimeout(waitForAPI, 100);
  }
}
window.addEventListener('pywebviewready', init);
// Fallback
setTimeout(waitForAPI, 500);
</script>
</body>
</html>
